<%- contentFor('HeaderCss') %>

<script src="frappe-gantt.min.js"></script>
<link rel="stylesheet" href="frappe-gantt.css">

<%- contentFor('breadcrumb') %>
<ul class="list-inline menu-left mb-0">
    <li class="list-inline-item">
        <button type="button" class="button-menu-mobile open-left waves-effect">
            <i class="ion-navicon"></i>
        </button>
    </li>
    <li class="hide-phone list-inline-item app-search">
        
        <div><h3 class="page-title">Flight Plan</h3>
        <span style="padding-left:40px;"><%= new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) %></span></div>
        
    </li>
</ul>

<%- contentFor('body') %>
<div class="page-content-wrapper">
    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-12">
              <div style="width: 1200px; margin: 20px auto;">
                <canvas id="ganttChart"></canvas>
              </div>
          </div>
        </div>
    </div>
</div>

<%- contentFor('FooterJs') %>
<script>
  fetch('/projects/flightview/ganttChart/')
  .then(response => response.json())
  .then(data => {
    const projects = data.companyProjects;
    const colors = data.colors;

    const colorMapping = {
      Green: "#28a745",
      Yellow: "#ffc107",
      Red: "#dc3545",
    };

    const phaseMapping = {
      1: "Pitch",
      2: "Priority",
      3: "Discovery",
      4: "Delivery",
      5: "Done",
    };

    // Convert API colors to hex codes
    const mappedColors = colors.map(color => colorMapping[color] || "#000000");
    const mappedPhases = projects.map(project => phaseMapping[project.phase_id]);

    // Prepare the data for Chart.js
    const chartData = {
      labels: projects.map(project => project.project_name),
      datasets: [{
        label: 'Timeline',
        data: projects.map(project => ({
          x: [new Date(project.start_date), new Date(project.end_date)],
          y: project.project_name
        })),
        backgroundColor: mappedColors,
        borderColor: mappedColors,
        borderWidth: 1,
        barPercentage: 0.7,
        categoryPercentage: 0.7,
        borderRadius: 10,
        borderSkipped: false
      }]
    };

    // Create the chart
    const ctx = document.getElementById('ganttChart').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: chartData,
      options: {
        indexAxis: 'y',
        scales: {
          x: {
            type: 'time',
            position: 'top',
            time: {
              unit: 'month'
            },
            min: new Date(Math.min(...projects.map(project => new Date(project.start_date)))),
            max: new Date(Math.max(...projects.map(project => new Date(project.end_date))))
          },
          y: {
            beginAtZero: true
          }
        },
        plugins: {
          datalabels: { 
            anchor: 'center', 
            align: 'center', 
            color: '#000000', 
            font: {
              weight: 'bold',
              size: 12
            },
            formatter: function(value, context) {
              return `${projects[context.dataIndex].project_name} - $${projects[context.dataIndex].project_cost}`; 
            }
          },
          tooltip: { // Keep tooltip on hover as well
            callbacks: {
              label: function(context) {
                const project = projects[context.dataIndex];
                return [
                  `Phase: ${phaseMapping[project.phase_id_fk]}`,
                  `Start: ${moment(project.start_date).format("DD MMM YY")}`,
                  `End: ${moment(project.end_date).format("DD MMM YY")}`
                ];
              }
            }
          }
        }
      },
      plugins: [ChartDataLabels]
    });
  });

</script>
<%- contentFor('BottomJs') %>
