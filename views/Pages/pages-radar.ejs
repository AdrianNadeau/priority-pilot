<%- contentFor('HeaderCss') %> <%- contentFor('breadcrumb') %>
<ul class="list-inline menu-left mb-0">
  <li class="list-inline-item">
    <button type="button" class="button-menu-mobile open-left waves-effect">
      <i class="ion-navicon"></i>
    </button>
  </li>
  <li class="hide-phone list-inline-item app-search">
    <h3 class="page-title">Radar</h3>
  </li>
</ul>

<%- contentFor('body') %>
<div class="page-content-wrapper">
  <div class="container" style="margin-left: 0.5em">
    <div class="row">
      <div class="col-lg-8">
        <div class="row">
          <div class="col-lg-2 text-center">
            <div class="card-body p-2">
              <strong class="h3">Funnel</strong>
              <br />
              <button
                type="button"
                class="btn btn-light"
                style="
                  background-color: #e2e6ea;
                  border-color: #e2e6ea;
                  margin-bottom: 5px;
                  width: 120px;
                  height: 50px;
                "
              >
                <%= pitchCount%>
              </button>
              <br />
              <button
                type="button"
                class="btn btn-light"
                style="
                  background-color: #e2e6ea;
                  border-color: #e2e6ea;
                  margin-bottom: 5px;
                  width: 120px;
                  height: 50px;
                "
              >
                $<%= pitchCost %>
              </button>
            </div>
          </div>
          <div class="col-lg-2 text-center">
            <div class="card-body p-2">
              <strong class="h3">Planning</strong>
              <br />
              <button
                type="button"
                class="btn btn-light"
                style="
                  background-color: #e2e6ea;
                  border-color: #e2e6ea;
                  margin-bottom: 5px;
                  width: 120px;
                  height: 50px;
                "
              >
                <%= priorityCount %>
              </button>
              <br />
              <button
                type="button"
                class="btn btn-light"
                style="
                  background-color: #e2e6ea;
                  border-color: #e2e6ea;
                  margin-bottom: 5px;
                  width: 120px;
                  height: 50px;
                "
              >
                $<%= priorityCost %>
              </button>
            </div>
          </div>
          <div class="col-lg-2 text-center">
            <div class="card-body p-2">
              <strong class="h3">Discovery</strong>
              <br />
              <button
                type="button"
                class="btn btn-light"
                style="
                  background-color: #e2e6ea;
                  border-color: #e2e6ea;
                  margin-bottom: 5px;
                  width: 120px;
                  height: 50px;
                "
              >
                <%= discoveryCount %>
              </button>
              <br />
              <button
                type="button"
                class="btn btn-light"
                style="
                  background-color: #e2e6ea;
                  border-color: #e2e6ea;
                  margin-bottom: 5px;
                  width: 120px;
                  height: 50px;
                "
              >
                $<%= discoveryCost %>
              </button>
            </div>
          </div>
          <div class="col-lg-2 text-center">
            <div class="card-body p-2">
              <strong class="h3">Delivery</strong>
              <br />
              <button
                type="button"
                class="btn btn-light"
                style="
                  background-color: #e2e6ea;
                  border-color: #e2e6ea;
                  margin-bottom: 5px;
                  width: 120px;
                  height: 50px;
                "
              >
                <%= deliveryCount %>
              </button>
              <br />
              <button
                type="button"
                class="btn btn-light"
                style="
                  background-color: #e2e6ea;
                  border-color: #e2e6ea;
                  margin-bottom: 5px;
                  width: 120px;
                  height: 50px;
                "
              >
                $<%= deliveryCost %>
              </button>
            </div>
          </div>
          <div class="col-lg-2 text-center">
            <div class="card-body p-2">
              <strong class="h3">Done</strong>
              <br />
              <button
                type="button"
                class="btn btn-light"
                style="
                  background-color: #e2e6ea;
                  border-color: #e2e6ea;
                  margin-bottom: 5px;
                  width: 120px;
                  height: 50px;
                "
              >
                <%= operationsCount %>
              </button>
              <br />
              <button
                type="button"
                class="btn btn-light"
                style="
                  background-color: #e2e6ea;
                  border-color: #e2e6ea;
                  margin-bottom: 5px;
                  width: 120px;
                  height: 50px;
                "
              >
                $<%= operationsTotalCost %>
              </button>
            </div>
          </div>
        </div>
        <div class="row mt-5">
          <div class="col-lg-10 text-center">
            <canvas id="barChart"></canvas>
          </div>
        </div>
      </div>

      <div class="col-lg-3">
        <div class="row">
          <canvas id="pieChart1"></canvas>
        </div>
        <div class="row mt-5">
          <div id="tag1Chart" width="2000" height="100"></div>
        </div>
        <div class="row mt-5">
          <div id="tag2Chart" width="1000" height="500"></div>
        </div>
        <div class="row mt-5">
          <div id="tag3Chart" width="1000" height="500"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<%- contentFor('FooterJs') %> <%- contentFor('BottomJs') %>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    fetch(`/projects/radar/progress`)
      .then((response) => response.json())
      .then((data) => {
        console.log("Data received:", data);
        // Select the canvas element
        if (typeof Chart !== "undefined") {
          const colorMapping = {
            Green: "#28a745",
            Yellow: "#ffc107",
            Red: "#dc3545",
          };

          // Convert API colors to hex codes
          const mappedColors = data.colors.map(
            (color) => colorMapping[color] || "#000000",
          );
          const barCtx = document.getElementById("barChart").getContext("2d");
          new Chart(barCtx, {
            type: "bar",
            data: {
              labels: data.project_names,
              datasets: [
                {
                  label: "Progress",
                  data: data.progress,
                  backgroundColor: mappedColors,
                  borderWidth: 1,
                },
              ],
            },
            options: {
              scales: {
                y: {
                  beginAtZero: true,
                  max: 100, // Fix vertical scale at 100
                  stepSize: 10, // Set interval to 10
                  title: {
                    display: true,
                    text: "Progress (%)", // Vertical axis label
                  },
                },
              },
              plugins: {
                tooltip: {
                  callbacks: {
                    // Custom tooltip for hover
                    label: function (tooltipItem) {
                      const progress = data.progress[tooltipItem.dataIndex];
                      return `Progress: ${progress}%`;
                    },
                  },
                },
              },
            },
          });

          // Define static colors and initialize counts
          const colorCounts = {
            Green: 0,
            Yellow: 0,
            Red: 0,
          };

          // Count occurrences of each color
          data.colors.forEach((color) => {
            if (colorCounts[color] !== undefined) {
              colorCounts[color] += 1;
            }
          });

          // Extract data for the chart
          const labels = Object.keys(colorCounts); // ["Green", "Yellow", "Red"]
          const counts = Object.values(colorCounts); // [3, 2, 1]
          const chartColors = ["#28a745", "#ffc107", "#dc3545"]; // Static colors for Green, Yellow, Red

          // Calculate percentages
          const total = counts.reduce((sum, count) => sum + count, 0);
          const percentages = counts.map((count) =>
            ((count / total) * 100).toFixed(1),
          ); // Percentages with 1 decimal point

          // Custom legend labels
          const customLabels = ["Healthy", "Caution", "In Trouble"];

          const pieCtx = document.getElementById("pieChart1").getContext("2d");
          new Chart(pieCtx, {
            type: "doughnut",
            data: {
              labels: labels, // Status labels
              datasets: [
                {
                  data: counts, // Count of projects in each category
                  backgroundColor: chartColors, // Status colors
                  borderWidth: 1,
                },
              ],
            },
            options: {
              plugins: {
                legend: {
                  display: true,
                  position: "top",
                  labels: {
                    generateLabels: function (chart) {
                      return chart.data.labels.map((label, index) => {
                        return {
                          text: `${customLabels[index]} (${percentages[index]}%)`,
                          fillStyle: chartColors[index], // Set the color for the label's box
                          strokeStyle: chartColors[index],
                          lineWidth: 1,
                        };
                      });
                    },
                    color: "#333", // Text color for legend
                    font: {
                      size: 14, // Font size for legend
                    },
                  },
                },
                tooltip: {
                  callbacks: {
                    label: function (tooltipItem) {
                      const status = customLabels[tooltipItem.dataIndex];
                      const count = counts[tooltipItem.dataIndex];
                      return `${status}: ${count} project(s)`;
                    },
                  },
                },
              },
            },
          });
        } else {
          console.error("Chart.js library NOT loaded");
          document.body.innerHTML =
            "<p>Error: Chart.js library failed to load</p>";
        }
      })
      .catch((err) => console.error(err));
  });
  function getRandomColorForTags() {
    const letters = "0123456789ABCDEF";
    let color = "#";
    for (let i = 0; i < 6; i++) {
      color += letters[Math.floor(Math.random() * 16)];
    }
    return color;
  }
</script>
<script type="text/javascript">
  google.charts.load("current", { packages: ["corechart"] });
  google.charts.setOnLoadCallback(drawChart);

  //fetch tag_1, tag_2, tag_3 from projects
  fetch(`/projects/radar/countProjectsByTag1`)
    .then((response) => response.json())
    .then((tags1) => {
      console.log("Tag Data received:", tags1);
    })
    .catch((err) => console.error(err));

  function drawChart() {
    fetch(`/projects/radar/countProjectsByTag1`)
      .then((response) => response.json())
      .then((tagsData) => {
        console.log("Tags Data received:", tagsData);

        // Prepare data for the chart
        const chartData = [["Task", "Hours per Day"]];
        tagsData.forEach((tag) => {
          chartData.push([tag.tag_name, parseInt(tag.project_count)]);
        });

        var data = google.visualization.arrayToDataTable(chartData);

        var options = {
          title: "Tag 1",
          pieHole: 0.4,
          backgroundColor: "transparent",
        };

        var chart = new google.visualization.PieChart(
          document.getElementById("tag1Chart"),
        );
        chart.draw(data, options);
      })
      .catch((error) => console.error("Error fetching tags:", error));

    fetch(`/projects/radar/countProjectsByTag2`)
      .then((response) => response.json())
      .then((tagsData) => {
        console.log("Tags 2 Data received:", tagsData);

        // Prepare data for the chart
        const chartData = [["Task", "Hours per Day"]];
        tagsData.forEach((tag) => {
          chartData.push([tag.tag_name, parseInt(tag.project_count)]);
        });

        var data = google.visualization.arrayToDataTable(chartData);

        var options = {
          title: "Tag 2",
          pieHole: 0.4,
          backgroundColor: "transparent",
        };

        var chart = new google.visualization.PieChart(
          document.getElementById("tag2Chart"),
        );
        chart.draw(data, options);
      })
      .catch((error) => console.error("Error fetching tags:", error));

    fetch(`/projects/radar/countProjectsByTag3`)
      .then((response) => response.json())
      .then((tagsData) => {
        console.log("Tags 3 Data received:", tagsData);

        // Prepare data for the chart
        const chartData = [["Task", "Hours per Day"]];
        tagsData.forEach((tag) => {
          chartData.push([tag.tag_name, parseInt(tag.project_count)]);
        });

        var data = google.visualization.arrayToDataTable(chartData);

        var options = {
          title: "Tag 3",
          pieHole: 0.4,
          backgroundColor: "transparent",
        };

        var chart = new google.visualization.PieChart(
          document.getElementById("tag3Chart"),
        );
        chart.draw(data, options);
      })
      .catch((error) => console.error("Error fetching tags:", error));
  }
</script>
